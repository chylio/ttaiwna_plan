<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å°ˆæ¡ˆç®¡ç†å„€è¡¨æ¿</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for main content */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }
        .main-content::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .main-content::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        /* Style for completed project label */
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <nav id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col shadow-xl">
        <div class="p-6 text-xl font-bold border-b border-gray-700 bg-gray-900">
            å°ˆæ¡ˆç¸½è¦½ç³»çµ±
        </div>
        <ul class="flex flex-col p-4 space-y-2">
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="dashboard">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7-8h14"></path></svg>
                    <span>å„€è¡¨æ¿ (Dashboard)</span>
                </span>
            </li>
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="projects">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <span>å°ˆæ¡ˆç®¡ç† (Projects)</span>
                </span>
            </li>
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="calendar">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>è¡Œäº‹æ›† (Calendar)</span>
                </span>
            </li>
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="managers">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.656-.126-1.283-.356-1.857M9 20h2v-2a3 3 0 00-5.356-1.857M9 20v-2c0-.656-.126-1.283-.356-1.857M9 14V5a2 2 0 012-2h2a2 2 0 012 2v9m-7 0h14"></path></svg>
                    <span>äººå“¡ç®¡ç† (Managers)</span>
                </span>
            </li>
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="ai-analysis">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>AI åˆ†æå ±å‘Š (AI Report)</span>
                </span>
            </li>
            <li class="nav-item cursor-pointer p-3 rounded-lg transition-colors hover:bg-gray-700" data-view="exchange">
                <span class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                    <span>è³‡è¨Šäº¤æµ (Exchange)</span>
                </span>
            </li>
        </ul>
        <div class="mt-auto p-4 text-sm text-gray-400">
            <p>ç”¨æˆ¶ ID: <span id="user-id">è®€å–ä¸­...</span></p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto main-content p-8">
        <header class="mb-8 border-b pb-4">
            <h1 id="page-title" class="text-3xl font-semibold text-gray-800">å„€è¡¨æ¿</h1>
        </header>

        <!-- View Containers -->
        <div id="dashboard-view" class="view-content" style="display: none;"></div>
        <div id="projects-view" class="view-content" style="display: none;"></div>
        <div id="project-detail-view" class="view-content" style="display: none;"></div>
        <div id="calendar-view" class="view-content" style="display: none;"></div>
        <div id="managers-view" class="view-content" style="display: none;"></div>
        <div id="ai-analysis-view" class="view-content" style="display: none;"></div>
        <div id="exchange-view" class="view-content" style="display: none;"></div>

        <!-- Modal for Confirmation/Message -->
        <div id="app-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 class="text-lg font-semibold mb-3" id="modal-title">è¨Šæ¯</h3>
                <p id="modal-message" class="text-gray-700 mb-4">æ“ä½œæˆåŠŸï¼</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors hidden">å–æ¶ˆ</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">ç¢ºå®š</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level to Debug for visibility
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase configuration is missing.");
        }

        // --- Data State ---
        let allProjects = [];
        let availableManagers = []; // æ–°å¢: ç®¡ç†äººåˆ—è¡¨ç‹€æ…‹
        let totalMetrics = {
            totalProjects: 0,
            totalBudget: 0,
            personnel: { budget: 0, spent: 0, balance: 0 },
            operating: { budget: 0, spent: 0, balance: 0 },
            equipment: { budget: 0, spent: 0, balance: 0 },
        };
        let currentView = 'dashboard';
        let selectedProjectId = null;
        let calendarEvents = [];
        let exchangeMessages = [];

        // --- Utility Functions ---

        /**
         * Formats a number as a currency string (Taiwan locale for clarity).
         * @param {number} amount
         * @returns {string}
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        };

        /**
         * Shows a custom modal instead of alert/confirm.
         * @param {string} title
         * @param {string} message
         * @param {boolean} showCancel
         * @returns {Promise<boolean>}
         */
        const showModal = (title, message, showCancel = false) => {
            return new Promise(resolve => {
                const modal = document.getElementById('app-modal');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').textContent = message;

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };

                if (showCancel) {
                    cancelBtn.classList.remove('hidden');
                    cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };
                } else {
                    cancelBtn.classList.add('hidden');
                }

                modal.classList.remove('hidden');
            });
        };

        /**
         * Switches the main view and updates the navigation and title.
         * @param {string} view
         */
        const switchView = (view, projectId = null) => {
            currentView = view;
            selectedProjectId = projectId;

            document.querySelectorAll('.view-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-gray-700'));

            document.getElementById('page-title').textContent = getPageTitle(view);

            if (view === 'project-detail') {
                 document.getElementById('project-detail-view').style.display = 'block';
                 renderProjectDetail(projectId);
                 document.querySelector(`.nav-item[data-view="projects"]`).classList.add('bg-gray-700');
            } else {
                document.getElementById(`${view}-view`).style.display = 'block';
                document.querySelector(`.nav-item[data-view="${view}"]`).classList.add('bg-gray-700');

                if (view === 'dashboard') renderDashboard();
                if (view === 'projects') renderProjectsList();
                if (view === 'calendar') renderCalendar();
                if (view === 'exchange') renderExchange();
                if (view === 'ai-analysis') renderAIAnalysis();
                if (view === 'managers') renderManagersView(); // æ¸²æŸ“ç®¡ç†äººç®¡ç†é é¢
            }
        };

        const getPageTitle = (view) => {
            switch (view) {
                case 'dashboard': return 'å°ˆæ¡ˆç®¡ç†å„€è¡¨æ¿';
                case 'projects': return 'å°ˆæ¡ˆåˆ—è¡¨èˆ‡æ–°å¢';
                case 'project-detail':
                    const project = allProjects.find(p => p.id === selectedProjectId);
                    return `å°ˆæ¡ˆè©³æƒ…: ${project ? project.title : 'N/A'}`;
                case 'calendar': return 'å°ˆæ¡ˆè¡Œäº‹æ›†èˆ‡æŒ‡æ´¾';
                case 'managers': return 'å°ˆæ¡ˆäººå“¡ç®¡ç†';
                case 'ai-analysis': return 'AI å°ˆæ¡ˆæ´»å‹•åˆ†æå ±å‘Š';
                case 'exchange': return 'è³‡è¨Šäº¤æµå€ (ç•™è¨€æ¿)';
                default: return 'å„€è¡¨æ¿';
            }
        };

        // --- Firebase/Auth Setup ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id').textContent = userId.substring(0, 8) + '...';
                isAuthReady = true;
                console.log("Auth State Changed: User signed in with UID:", userId);
                
                // Start listening to data
                listenToPrivateData();
                listenToManagers(); // NEW: ç›£è½ç®¡ç†äººåå–®
                listenToPublicMessages();
                
                // Render initial view
                switchView(currentView);

                // NEW: é¦–æ¬¡é‹è¡Œæ™‚ï¼ŒåŒ¯å…¥åˆå§‹ç®¡ç†äººåå–®
                await seedInitialManagers();
            } else {
                // ç™»å‡ºç‹€æ…‹ï¼Œç”±ä¸‹æ–¹é‚è¼¯è™•ç†ç™»å…¥
            }
        });

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.error("Custom token sign-in failed:", error);
                signInAnonymously(auth); // Fallback
            });
        } else if (auth) {
             signInAnonymously(auth); // Sign in anonymously if no token is available
        }


        // --- New: Managers Seeding Function ---
        const seedInitialManagers = async () => {
            if (!db || !userId) return;

            const managerCollectionRef = collection(db, getPrivateCollectionPath('managers'));
            try {
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»»ä½•ç®¡ç†äºº
                const snapshot = await getDocs(managerCollectionRef);
                if (snapshot.empty) {
                    const initialList = ["è”¡é›…é›¯", "é™³ä¹ƒè", "å³æ›‰çª", "è˜‡ç¬æ·³", "æ¥Šç©æ½”"];
                    for (const name of initialList) {
                        // ä½¿ç”¨ name ä½œç‚º Document IDï¼Œæ–¹ä¾¿ç®¡ç†å’Œåˆªé™¤
                        await setDoc(doc(managerCollectionRef, name), { name: name, createdAt: serverTimestamp() });
                    }
                    console.log("Seeded initial managers.");
                }
            } catch (error) {
                console.error("Error seeding initial managers:", error);
            }
        };


        // --- Firestore Data Listeners (Real-time) ---

        const getPrivateCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}`;
        const getPublicCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

        const listenToPrivateData = () => {
            if (!db || !userId) return;

            const q = collection(db, getPrivateCollectionPath('projects'));
            onSnapshot(q, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                allProjects = projects;
                calculateTotalMetrics(projects);
                
                // Re-render the current view to reflect data changes
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'projects') renderProjectsList();
                if (currentView === 'project-detail' && selectedProjectId) renderProjectDetail(selectedProjectId);
                if (currentView === 'calendar') renderCalendar(); // Re-render calendar on data change
            }, (error) => {
                console.error("Error listening to projects:", error);
            });
        };

        // NEW: Listener for Managers
        const listenToManagers = () => {
            if (!db || !userId) return;

            const q = query(collection(db, getPrivateCollectionPath('managers')), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snapshot) => {
                availableManagers = [];
                snapshot.forEach(doc => {
                    availableManagers.push({ id: doc.id, name: doc.data().name });
                });
                
                // Re-render views that depend on manager list
                if (currentView === 'projects') renderProjectsList();
                if (currentView === 'calendar') renderCalendar();
                if (currentView === 'managers') renderManagersView();
                
            }, (error) => {
                console.error("Error listening to managers:", error);
            });
        };

        const listenToPublicMessages = () => {
            if (!db) return;

            const q = query(collection(db, getPublicCollectionPath('messages')), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snapshot) => {
                exchangeMessages = [];
                snapshot.forEach(doc => {
                    exchangeMessages.push({ id: doc.id, ...doc.data() });
                });
                if (currentView === 'exchange') renderExchange();
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
        };


        // --- Core Metric Calculation ---

        const calculateTotalMetrics = (projects) => {
            let totalProjects = projects.length;
            let totalBudget = 0;
            let p_budget = 0, p_spent = 0;
            let o_budget = 0, o_spent = 0;
            let e_budget = 0, e_spent = 0;

            projects.forEach(p => {
                const bp = p.budget_personnel || 0;
                const bo = p.budget_operating || 0;
                const be = p.budget_equipment || 0;

                // NEW: Recalculate spent based on the detailed expenses array for accuracy
                let projectSpent = { personnel: 0, operating: 0, equipment: 0 };
                (p.expenses || []).forEach(exp => {
                    projectSpent[exp.type] += exp.amount;
                });
                
                p_spent += projectSpent.personnel;
                o_spent += projectSpent.operating;
                e_spent += projectSpent.equipment;

                totalBudget += bp + bo + be;
            });

            totalMetrics = {
                totalProjects,
                totalBudget,
                personnel: { budget: p_budget, spent: p_spent, balance: p_budget - p_spent },
                operating: { budget: o_budget, spent: o_spent, balance: o_budget - o_spent },
                equipment: { budget: e_budget, spent: e_spent, balance: e_budget - e_spent },
            };
        };


        // --- View Rendering Functions ---

        // 1. Dashboard View
        const renderDashboard = () => {
            const m = totalMetrics;

            const metricCard = (title, value, unit) => `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 transition-shadow duration-300 hover:shadow-xl">
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1">${value}</p>
                    ${unit ? `<p class="text-xs text-gray-400 mt-1">${unit}</p>` : ''}
                </div>
            `;

            const expenseCard = (title, data) => {
                const percentage = data.budget > 0 ? ((data.spent / data.budget) * 100).toFixed(1) : 0;
                const balanceClass = data.balance >= 0 ? 'text-green-600' : 'text-red-600';
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-400">
                        <h4 class="text-xl font-semibold mb-4 text-gray-800">${title}</h4>
                        <div class="space-y-3">
                            <p class="text-md flex justify-between">
                                <span class="font-medium text-gray-600">ç¸½é ç®—:</span> 
                                <span class="font-bold">${formatCurrency(data.budget)}</span>
                            </p>
                            <p class="text-md flex justify-between">
                                <span class="font-medium text-gray-600">å·²å¡«å ±é‡‘é¡:</span> 
                                <span class="font-bold text-yellow-600">${formatCurrency(data.spent)}</span>
                            </p>
                            <p class="text-lg flex justify-between border-t pt-3 mt-3">
                                <span class="font-bold text-gray-700">é¤˜é¡:</span> 
                                <span class="font-extrabold ${balanceClass}">${formatCurrency(data.balance)}</span>
                            </p>
                        </div>
                        <div class="mt-4">
                            <div class="h-2 bg-gray-200 rounded-full">
                                <div class="h-2 bg-indigo-500 rounded-full" style="width: ${Math.min(percentage, 100)}%;"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">æ”¯å‡ºæ¯”ä¾‹: ${percentage}%</p>
                        </div>
                    </div>
                `;
            };

            const html = `
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${metricCard('å°ˆæ¡ˆç¸½æ•¸', m.totalProjects, 'å€‹')}
                    ${metricCard('æ‰€æœ‰å°ˆæ¡ˆé ç®—ç¸½è¨ˆ', formatCurrency(m.totalBudget), 'TWD')}
                    ${metricCard('äººäº‹è²»ç¸½é¤˜é¡', formatCurrency(m.personnel.balance), m.personnel.balance >= 0 ? 'ç‹€æ³è‰¯å¥½' : 'å·²è¶…æ”¯')}
                    ${metricCard('æ¥­å‹™è²»ç¸½é¤˜é¡', formatCurrency(m.operating.balance), m.operating.balance >= 0 ? 'ç‹€æ³è‰¯å¥½' : 'å·²è¶…æ”¯')}
                </section>

                <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    ${expenseCard('äººäº‹è²» (Personnel)', m.personnel)}
                    ${expenseCard('æ¥­å‹™è²» (Operating)', m.operating)}
                    ${expenseCard('è¨­å‚™è²» (Equipment)', m.equipment)}
                </section>
                
                <section class="mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">å°ˆæ¡ˆæ¦‚æ³</h2>
                    <div id="dashboard-project-list" class="bg-white p-4 rounded-xl shadow-lg overflow-x-auto">
                        ${renderProjectSummaryTable()}
                    </div>
                </section>
            `;

            document.getElementById('dashboard-view').innerHTML = html;
        };

        const renderProjectSummaryTable = () => {
            // UPDATED: Create a dropdown structure for project list if there are many projects (mock limit: 10)
            if (allProjects.length === 0) {
                return '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å°ˆæ¡ˆã€‚è«‹åˆ°å°ˆæ¡ˆç®¡ç†é é¢æ–°å¢ã€‚</p>';
            }

            const projectsToDisplay = allProjects.filter(p => p.status !== 'completed');
            const completedProjects = allProjects.filter(p => p.status === 'completed');

            const headerClass = "px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            const cellClass = "px-4 py-2 whitespace-nowrap text-sm text-gray-800";

            const createTableBody = (projects) => projects.map(p => {
                const totalBudget = (p.budget_personnel || 0) + (p.budget_operating || 0) + (p.budget_equipment || 0);
                // NEW: Use aggregate spent from metrics calculation
                const totalSpent = (p.expenses || []).reduce((sum, exp) => sum + exp.amount, 0);
                const balance = totalBudget - totalSpent;
                const balanceClass = balance >= 0 ? 'text-green-600' : 'text-red-600';
                
                const managersDisplay = (p.managers && Array.isArray(p.managers)) ? p.managers.join(', ') : (p.manager || 'N/A');
                
                return `
                    <tr class="hover:bg-indigo-50 cursor-pointer ${p.status === 'completed' ? 'opacity-70' : ''}" onclick="window.switchView('project-detail', '${p.id}')">
                        <td class="${cellClass} font-medium">${p.title || 'N/A'} 
                            ${p.status === 'completed' ? '<span class="status-completed text-xs font-bold px-2 py-0.5 rounded-full ml-2">å·²çµæ¡ˆ</span>' : ''}
                        </td>
                        <td class="${cellClass}">${p.host || 'N/A'}</td>
                        <td class="${cellClass}">${managersDisplay}</td>
                        <td class="${cellClass}">${formatCurrency(totalBudget)}</td>
                        <td class="${cellClass} text-yellow-600">${formatCurrency(totalSpent)}</td>
                        <td class="${cellClass} ${balanceClass} font-semibold">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');


            let html = `
                <table class="min-w-full divide-y divide-gray-200 mb-6">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="${headerClass}">è¨ˆç•«é¡Œç›®</th>
                            <th class="${headerClass}">è¨ˆç•«ä¸»æŒäºº</th>
                            <th class="${headerClass}">å°ˆæ¡ˆç®¡ç†äºº</th>
                            <th class="${headerClass}">ç¸½é ç®—</th>
                            <th class="${headerClass}">ç¸½èŠ±è²»</th>
                            <th class="${headerClass}">é¤˜é¡</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${createTableBody(projectsToDisplay)}
                    </tbody>
                </table>
            `;

            if (completedProjects.length > 0) {
                 html += `
                    <details class="mt-4 border rounded-lg">
                        <summary class="p-3 cursor-pointer bg-gray-100 font-semibold text-gray-700 hover:bg-gray-200">
                            å·²çµæ¡ˆå°ˆæ¡ˆ (${completedProjects.length} å€‹) - é»æ“Šå±•é–‹/æ”¶åˆ
                        </summary>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="${headerClass}">è¨ˆç•«é¡Œç›®</th>
                                        <th class="${headerClass}">è¨ˆç•«ä¸»æŒäºº</th>
                                        <th class="${headerClass}">å°ˆæ¡ˆç®¡ç†äºº</th>
                                        <th class="${headerClass}">ç¸½é ç®—</th>
                                        <th class="${headerClass}">ç¸½èŠ±è²»</th>
                                        <th class="${headerClass}">é¤˜é¡</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${createTableBody(completedProjects)}
                                </tbody>
                            </table>
                        </div>
                    </details>
                 `;
            }

            return html;
        };
        

        // 2. Projects List View and New Project Form
        const renderProjectsList = () => {
            const html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- New Project Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">æ–°å¢å°ˆæ¡ˆè¨ˆç•«</h2>
                        <form id="new-project-form" class="space-y-4">
                            <input type="text" id="project_id" placeholder="è¨ˆç•«ç·¨è™Ÿ (Project ID)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="text" id="project_title" placeholder="è¨ˆç•«é¡Œç›® (Title)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <input type="text" id="project_host" placeholder="è¨ˆç•«ä¸»æŒäºº (Host)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <!-- NEW: Multi-select dropdown for Project Managers -->
                            <h3 class="font-semibold pt-2 text-gray-700">å°ˆæ¡ˆç®¡ç†äºº</h3>
                            <select id="project_managers" multiple required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-32 text-sm">
                                ${availableManagers.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                            </select>
                            <p class="text-xs text-gray-500 -mt-3">æŒ‰ä½ Ctrl/Cmd (æˆ–åœ¨è¡Œå‹•è£ç½®ä¸Šé•·æŒ‰) å¯å¤šé¸å°ˆæ¡ˆç®¡ç†äºº (è‡³å°‘é¸ä¸€ä½)ã€‚</p>

                            <h3 class="font-semibold pt-2 text-gray-700">é ç®—é‡‘é¡ (Budget)</h3>
                            <!-- UPDATED: Added clear text labels (Point 1) -->
                            <label for="budget_personnel" class="block text-sm font-medium text-gray-700">äººäº‹è²»è£œåŠ©é‡‘é¡</label>
                            <input type="number" id="budget_personnel" placeholder="è«‹è¼¸å…¥äººäº‹è²»ç¸½é ç®—" required min="0" value="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <label for="budget_operating" class="block text-sm font-medium text-gray-700">æ¥­å‹™è²»è£œåŠ©é‡‘é¡</label>
                            <input type="number" id="budget_operating" placeholder="è«‹è¼¸å…¥æ¥­å‹™è²»ç¸½é ç®—" required min="0" value="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <label for="budget_equipment" class="block text-sm font-medium text-gray-700">è¨­å‚™è²»è£œåŠ©é‡‘é¡</label>
                            <input type="number" id="budget_equipment" placeholder="è«‹è¼¸å…¥è¨­å‚™è²»ç¸½é ç®—" required min="0" value="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            
                            <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md">
                                <span id="project-submit-text">æ–°å¢è¨ˆç•«</span>
                            </button>
                        </form>
                    </div>

                    <!-- Project List Table -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">ç¾æœ‰å°ˆæ¡ˆåˆ—è¡¨</h2>
                        <div id="project-list-table-container" class="overflow-x-auto">
                            ${renderProjectListTable()}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('projects-view').innerHTML = html;

            document.getElementById('new-project-form').onsubmit = handleNewProject;
        };
        
        const renderProjectListTable = () => {
            if (allProjects.length === 0) {
                return '<p class="text-gray-500 text-center py-12">è«‹åœ¨å·¦å´è¡¨å–®æ–°å¢ç¬¬ä¸€å€‹å°ˆæ¡ˆã€‚</p>';
            }

            const headerClass = "px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
            const cellClass = "px-4 py-2 whitespace-nowrap text-sm";

            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="${headerClass}">è¨ˆç•«ç·¨è™Ÿ</th>
                            <th class="${headerClass}">è¨ˆç•«é¡Œç›®</th>
                            <th class="${headerClass}">ä¸»æŒäºº / ç®¡ç†äºº</th>
                            <th class="${headerClass}">ç¸½é ç®—</th>
                            <th class="${headerClass}">ç‹€æ…‹</th>
                            <th class="${headerClass}">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${allProjects.map(p => {
                            const totalBudget = (p.budget_personnel || 0) + (p.budget_operating || 0) + (p.budget_equipment || 0);
                            
                            // é¡¯ç¤ºå¤šå€‹ç®¡ç†äºº
                            const managersDisplay = (p.managers && Array.isArray(p.managers)) ? p.managers.join(', ') : (p.manager || 'N/A');
                            const statusLabel = p.status === 'completed' ? 'å·²çµæ¡ˆ' : 'åŸ·è¡Œä¸­';
                            const statusClass = p.status === 'completed' ? 'status-completed' : 'bg-blue-100 text-blue-800';

                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="${cellClass} font-medium">${p.id || 'N/A'}</td>
                                    <td class="${cellClass} text-indigo-600 hover:underline cursor-pointer" onclick="window.switchView('project-detail', '${p.id}')">${p.title || 'N/A'}</td>
                                    <td class="${cellClass}">${p.host} / ${managersDisplay}</td>
                                    <td class="${cellClass} text-right">${formatCurrency(totalBudget)}</td>
                                    <td class="${cellClass}">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${statusClass}">${statusLabel}</span>
                                    </td>
                                    <td class="${cellClass}">
                                        <button onclick="window.switchView('project-detail', '${p.id}')" class="text-indigo-600 hover:text-indigo-900 text-xs font-medium mr-2">è©³æƒ…</button>
                                        <button onclick="window.handleDeleteProject('${p.id}', '${p.title}')" class="text-red-600 hover:text-red-900 text-xs font-medium">åˆªé™¤</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        };

        const handleNewProject = async (e) => {
            e.preventDefault();
            
            const submitText = document.getElementById('project-submit-text');
            submitText.textContent = 'æ–°å¢ä¸­...';
            submitText.disabled = true;

            const managerSelect = document.getElementById('project_managers');
            const selectedManagers = Array.from(managerSelect.selectedOptions).map(option => option.value);

            if (selectedManagers.length === 0) {
                await showModal('éŒ¯èª¤', 'è«‹è‡³å°‘é¸æ“‡ä¸€ä½å°ˆæ¡ˆç®¡ç†äººã€‚');
                submitText.textContent = 'æ–°å¢è¨ˆç•«';
                submitText.disabled = false;
                return;
            }

            const projectData = {
                id: document.getElementById('project_id').value.trim(), 
                title: document.getElementById('project_title').value,
                host: document.getElementById('project_host').value,
                managers: selectedManagers,
                budget_personnel: parseInt(document.getElementById('budget_personnel').value) || 0,
                budget_operating: parseInt(document.getElementById('budget_operating').value) || 0,
                budget_equipment: parseInt(document.getElementById('budget_equipment').value) || 0,
                // NEW: Initialize status and expenses
                status: 'active', 
                memo: '',
                expenses: [], 
                createdAt: serverTimestamp(),
            };
            
            try {
                // Use the project ID as the Firestore document ID for easy reference, but check if it already exists
                const docRef = doc(db, getPrivateCollectionPath('projects'), projectData.id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    await showModal('éŒ¯èª¤', `è¨ˆç•«ç·¨è™Ÿ ${projectData.id} å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ç·¨è™Ÿã€‚`);
                    return;
                }

                await setDoc(docRef, projectData);

                 // --- ğŸ”„ åŒæ­¥åˆ° Google Sheet ---
                try {
                 const googleScriptURL = "ğŸŸ© åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Apps Script ç¶²å€";
                 await fetch(googleScriptURL, {
                   method: "POST",
                   body: JSON.stringify(projectData),
                   headers: { "Content-Type": "application/json" }
                  });
                  console.log("âœ… å·²åŒæ­¥åˆ° Google Sheet");
                }catch (err) {
                  console.error("âŒ åŒæ­¥ Google Sheet å¤±æ•—:", err);
                }

                 // --- åŸæœ‰çµå°¾ ---
                 document.getElementById('new-project-form').reset();
                 await showModal('æˆåŠŸ', `å°ˆæ¡ˆã€Œ${projectData.title}ã€å·²æˆåŠŸæ–°å¢ï¼`);
            } catch (error) {
                console.error("Error adding project:", error);
                await showModal('éŒ¯èª¤', 'æ–°å¢å°ˆæ¡ˆå¤±æ•—ã€‚è«‹æª¢æŸ¥é€£ç·šæˆ–è¼¸å…¥è³‡æ–™ã€‚');
            } finally {
                submitText.textContent = 'æ–°å¢è¨ˆç•«';
                submitText.disabled = false;
            }
        };

        const handleDeleteProject = async (projectId, projectTitle) => {
            const confirmed = await showModal('ç¢ºèªåˆªé™¤', `æ‚¨ç¢ºå®šè¦åˆªé™¤å°ˆæ¡ˆã€Œ${projectTitle}ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†è½‰ã€‚`, true);
            if (!confirmed) return;

            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('projects'), projectId));
                await showModal('æˆåŠŸ', `å°ˆæ¡ˆã€Œ${projectTitle}ã€å·²æˆåŠŸåˆªé™¤ã€‚`);
            } catch (error) {
                console.error("Error deleting project:", error);
                await showModal('éŒ¯èª¤', 'åˆªé™¤å°ˆæ¡ˆå¤±æ•—ã€‚');
            }
        };
        window.handleDeleteProject = handleDeleteProject; // Expose to global scope for HTML event

        // 3. Project Detail View and Expense Logging
        const renderProjectDetail = (projectId) => {
            const project = allProjects.find(p => p.id === projectId);
            if (!project) {
                document.getElementById('project-detail-view').innerHTML = '<div class="text-center py-12 text-gray-500">æ‰¾ä¸åˆ°æ­¤å°ˆæ¡ˆã€‚</div>';
                return;
            }
            
            // NEW: Calculate spent from expenses array
            const projectSpent = (project.expenses || []).reduce((acc, exp) => {
                acc[exp.type] = (acc[exp.type] || 0) + exp.amount;
                return acc;
            }, { personnel: 0, operating: 0, equipment: 0 });

            const totalBudget = (project.budget_personnel || 0) + (project.budget_operating || 0) + (project.budget_equipment || 0);
            const totalSpent = projectSpent.personnel + projectSpent.operating + projectSpent.equipment;
            const totalBalance = totalBudget - totalSpent;
            
            const expenseBlock = (title, key) => {
                const budget = project[`budget_${key}`] || 0;
                const spent = projectSpent[key] || 0; // Use calculated spent
                const balance = budget - spent;
                const percentage = budget > 0 ? ((spent / budget) * 100).toFixed(1) : 0;
                const balanceClass = balance >= 0 ? 'text-green-600' : 'text-red-600';
                
                return `
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h5 class="font-semibold text-lg mb-2 text-gray-800">${title}</h5>
                        <p class="text-sm">é ç®—: <span class="font-medium">${formatCurrency(budget)}</span></p>
                        <p class="text-sm">å·²èŠ±è²»: <span class="font-medium text-yellow-600">${formatCurrency(spent)}</span></p>
                        <p class="text-sm font-bold mt-1 ${balanceClass}">é¤˜é¡: ${formatCurrency(balance)}</p>
                        <div class="h-2 bg-gray-300 rounded-full mt-2">
                            <div class="h-2 bg-indigo-500 rounded-full" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">é€²åº¦: ${percentage}%</p>
                    </div>
                `;
            };

            // é¡¯ç¤ºå¤šå€‹ç®¡ç†äºº
            const managersDisplay = (project.managers && Array.isArray(project.managers)) ? project.managers.join(', ') : (project.manager || 'N/A');
            
            const isCompleted = project.status === 'completed';
            const statusText = isCompleted ? 'å·²çµæ¡ˆ' : 'åŸ·è¡Œä¸­';
            const statusClass = isCompleted ? 'status-completed' : 'bg-blue-100 text-blue-800';
            const toggleButtonText = isCompleted ? 'é‡å•Ÿå°ˆæ¡ˆ' : 'çµæ¡ˆå°ˆæ¡ˆ';
            const toggleButtonClass = isCompleted ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-red-600 hover:bg-red-700';

            const expenseHistory = (project.expenses || []).sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            const html = `
                <button onclick="window.switchView('projects')" class="mb-4 text-indigo-600 hover:text-indigo-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    è¿”å›å°ˆæ¡ˆåˆ—è¡¨
                </button>

                <div class="bg-white p-6 rounded-xl shadow-xl ${isCompleted ? 'border-2 border-green-500' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-indigo-600">${project.title} (${project.id})</h2>
                        <span class="text-lg font-bold px-3 py-1 rounded-full ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-6 pb-4 border-b">
                        <p><strong>ä¸»æŒäºº:</strong> ${project.host}</p>
                        <p><strong>ç®¡ç†äºº:</strong> ${managersDisplay}</p>
                        <p><strong>ç¸½é ç®—:</strong> <span class="font-bold">${formatCurrency(totalBudget)}</span></p>
                        <p><strong>ç¸½é¤˜é¡:</strong> <span class="font-bold ${totalBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(totalBalance)}</span></p>
                    </div>

                    <!-- Expense Overview -->
                    <h3 class="text-xl font-semibold mb-3">ç¶“è²»ç´°é …ç¸½è¦½</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        ${expenseBlock('äººäº‹è²»', 'personnel')}
                        ${expenseBlock('æ¥­å‹™è²»', 'operating')}
                        ${expenseBlock('è¨­å‚™è²»', 'equipment')}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Expense Logging Form -->
                        <div class="p-4 border rounded-xl shadow-inner ${isCompleted ? 'opacity-50 pointer-events-none' : ''}">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2">å¡«å ±æ­¤æ¬¡èŠ±è²» (Expense Logging)</h3>
                            <form id="expense-log-form" data-project-id="${projectId}" class="space-y-4">
                                <select id="expense_type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                    <option value="" disabled selected>é¸æ“‡èŠ±è²»é¡åˆ¥</option>
                                    <option value="personnel">äººäº‹è²»</option>
                                    <option value="operating">æ¥­å‹™è²»</option>
                                    <option value="equipment">è¨­å‚™è²»</option>
                                </select>
                                <input type="number" id="expense_amount" placeholder="æ­¤æ¬¡èŠ±è²»é‡‘é¡" required min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                                <textarea id="expense_memo" rows="2" placeholder="èŠ±è²»ç´°é …å‚™è¨» (ä¾‹å¦‚ï¼šè³¼è²·è¨­å‚™å‹è™Ÿ)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                                <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md">
                                    <span id="expense-submit-text">ç¢ºèªå¡«å ±èˆ‡è¨˜éŒ„</span>
                                </button>
                            </form>
                        </div>

                        <!-- Project Memo & Status Update -->
                        <div class="p-4 border rounded-xl shadow-inner">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2">å°ˆæ¡ˆå‚™è¨»èˆ‡ç‹€æ…‹</h3>
                            <form id="project-memo-form" data-project-id="${projectId}" class="space-y-4">
                                <label for="project_memo" class="block text-sm font-medium text-gray-700">å°ˆæ¡ˆç¸½å‚™è¨»</label>
                                <textarea id="project_memo" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${project.memo || ''}</textarea>
                                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md">
                                    å„²å­˜å‚™è¨»
                                </button>
                            </form>
                            
                            <button onclick="window.handleToggleProjectStatus('${projectId}', '${isCompleted ? 'active' : 'completed'}', '${project.title}')" 
                                class="w-full mt-4 p-3 rounded-lg font-semibold text-white transition-colors shadow-md ${toggleButtonClass}">
                                ${toggleButtonText}
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">çµæ¡ˆå¾Œç„¡æ³•å†é€²è¡ŒèŠ±è²»å¡«å ±ã€‚</p>
                        </div>
                    </div>
                    
                    <!-- Expense History -->
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold mb-3 border-t pt-4">èŠ±è²»ç´°é …è¨˜éŒ„ (${expenseHistory.length} ç­†)</h3>
                        <div class="overflow-x-auto bg-gray-50 rounded-lg p-2 max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">æ—¥æœŸ</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">é¡åˆ¥</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 uppercase">é‡‘é¡</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase">å‚™è¨»/ç´°é …</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${expenseHistory.length === 0 ? `
                                        <tr><td colspan="4" class="text-center py-4 text-gray-500">ç›®å‰æ²’æœ‰èŠ±è²»è¨˜éŒ„ã€‚</td></tr>
                                    ` : expenseHistory.map(exp => `
                                        <tr>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800">${exp.timestamp?.toDate ? exp.timestamp.toDate().toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-indigo-600">${exp.type === 'personnel' ? 'äººäº‹è²»' : exp.type === 'operating' ? 'æ¥­å‹™è²»' : 'è¨­å‚™è²»'}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-semibold">${formatCurrency(exp.amount)}</td>
                                            <td class="px-4 py-2 text-sm text-gray-600">${exp.memo || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('project-detail-view').innerHTML = html;
            document.getElementById('expense-log-form').onsubmit = handleExpenseLog;
            document.getElementById('project-memo-form').onsubmit = handleUpdateProjectMemo;
        };

        const handleUpdateProjectMemo = async (e) => {
            e.preventDefault();
            const form = e.target;
            const projectId = form.getAttribute('data-project-id');
            const memo = document.getElementById('project_memo').value;
            
            try {
                const docRef = doc(db, getPrivateCollectionPath('projects'), projectId);
                await updateDoc(docRef, { memo: memo });
                await showModal('æˆåŠŸ', 'å°ˆæ¡ˆå‚™è¨»å·²æˆåŠŸå„²å­˜ã€‚');
            } catch (error) {
                console.error("Error updating memo:", error);
                await showModal('éŒ¯èª¤', 'å„²å­˜å‚™è¨»å¤±æ•—ã€‚');
            }
        };
        window.handleUpdateProjectMemo = handleUpdateProjectMemo; // Expose globally

        const handleToggleProjectStatus = async (projectId, newStatus, projectTitle) => {
            const actionText = newStatus === 'completed' ? 'çµæ¡ˆ' : 'é‡å•Ÿ';
            const confirmed = await showModal('ç¢ºèªæ“ä½œ', `æ‚¨ç¢ºå®šè¦${actionText}å°ˆæ¡ˆã€Œ${projectTitle}ã€å—ï¼Ÿ`, true);
            if (!confirmed) return;
            
            try {
                const docRef = doc(db, getPrivateCollectionPath('projects'), projectId);
                await updateDoc(docRef, { status: newStatus });
                await showModal('æˆåŠŸ', `å°ˆæ¡ˆã€Œ${projectTitle}ã€å·²æˆåŠŸ${actionText}ã€‚`);
            } catch (error) {
                console.error(`Error ${actionText} project:`, error);
                await showModal('éŒ¯èª¤', `${actionText}å°ˆæ¡ˆå¤±æ•—ã€‚`);
            }
        };
        window.handleToggleProjectStatus = handleToggleProjectStatus; // Expose globally


        const handleExpenseLog = async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const projectId = form.getAttribute('data-project-id');
            const expenseType = document.getElementById('expense_type').value;
            const expenseAmount = parseInt(document.getElementById('expense_amount').value) || 0;
            const expenseMemo = document.getElementById('expense_memo').value.trim(); // NEW
            const submitText = document.getElementById('expense-submit-text');

            if (!expenseType || expenseAmount <= 0) {
                await showModal('éŒ¯èª¤', 'è«‹é¸æ“‡èŠ±è²»é¡åˆ¥ä¸¦è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ã€‚');
                return;
            }

            submitText.textContent = 'å¡«å ±ä¸­...';
            submitText.disabled = true;
            
            const docRef = doc(db, getPrivateCollectionPath('projects'), projectId);
            const newExpense = {
                type: expenseType,
                amount: expenseAmount,
                memo: expenseMemo,
                timestamp: serverTimestamp()
            };

            try {
                await runTransaction(db, async (transaction) => {
                    const projectDoc = await transaction.get(docRef);
                    if (!projectDoc.exists()) {
                        throw "Project does not exist!";
                    }
                    
                    const currentExpenses = projectDoc.data().expenses || [];
                    const updatedExpenses = [...currentExpenses, newExpense];
                    
                    transaction.update(docRef, { expenses: updatedExpenses });
                });
                
                form.reset();
                await showModal('æˆåŠŸ', `å·²æˆåŠŸè¨˜éŒ„ä¸€ç­† ${formatCurrency(expenseAmount)} çš„èŠ±è²»ç´°é …ï¼`);
            } catch (error) {
                console.error("Transaction failed:", error);
                await showModal('éŒ¯èª¤', 'å¡«å ±èŠ±è²»å¤±æ•—ã€‚è«‹æª¢æŸ¥é€£ç·šæˆ–è³‡æ–™ã€‚');
            } finally {
                submitText.textContent = 'ç¢ºèªå¡«å ±èˆ‡è¨˜éŒ„';
                submitText.disabled = false;
            }
        };


        // 4. Calendar View
        const renderCalendar = () => {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // This is a simple client-side calendar representation
            const renderMonth = (year, month) => {
                const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) to 6 (Sat)
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const monthName = new Date(year, month).toLocaleString('zh-TW', { month: 'long' });
                
                let calendarCells = '';
                
                // Add blank days for padding
                for (let i = 0; i < firstDay; i++) {
                    calendarCells += '<div class="h-24 p-2 border"></div>';
                }

                // Add days
                for (let day = 1; day <= daysInMonth; day++) {
                    const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = allProjects.flatMap(p => 
                        (p.calendar_events || []).filter(e => e.date === fullDate).map(e => ({...e, projectTitle: p.title}))
                    );

                    calendarCells += `
                        <div class="h-24 p-2 border relative overflow-y-auto hover:bg-indigo-50 transition-colors cursor-pointer" 
                            onclick="window.showCalendarModal('${fullDate}')" 
                            title="é»æ“Šæ–°å¢äº‹é …">
                            <p class="text-sm font-semibold">${day}</p>
                            <div class="space-y-0.5 mt-1">
                                ${events.map(e => `
                                    <div class="text-xs truncate bg-indigo-100 text-indigo-800 px-1 rounded" title="${e.projectTitle}: ${e.task} (${e.manager})">
                                        ${e.task}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <h3 class="text-2xl font-bold mb-4 text-center text-gray-800">${year} å¹´ ${monthName}</h3>
                    <div class="grid grid-cols-7 text-center font-medium text-sm mb-2 text-gray-600">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div class="grid grid-cols-7 border-t border-l">
                        ${calendarCells}
                    </div>
                `;
            };

            const html = `
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                        ${renderMonth(year, month)}
                    </div>
                    
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">æ–°å¢æ’ç¨‹äº‹é …</h3>
                        <form id="calendar-event-form" class="space-y-4">
                            <select id="event_project_id" required class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>æŒ‡æ´¾çµ¦å°ˆæ¡ˆ...</option>
                                ${allProjects.map(p => `<option value="${p.id}">${p.title} (${(p.managers || []).join(', ')})</option>`).join('')} 
                            </select>
                            <input type="date" id="event_date" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="event_task" placeholder="äº‹é …æè¿°æˆ–è¨ˆç•«åç¨±" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <!-- NEW: Dropdown for assigning the specific task manager -->
                            <select id="event_manager" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="" selected>æŒ‡æ´¾çµ¦ç®¡ç†äºº (é¸å¡«)</option>
                                ${availableManagers.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                            </select>
                            <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                æ–°å¢äº‹é …
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('calendar-view').innerHTML = html;
            document.getElementById('calendar-event-form').onsubmit = handleCalendarEvent;
        };

        const showCalendarModal = (date) => {
            const dateInput = document.getElementById('event_date');
            if (dateInput) dateInput.value = date;
            
            // Switch to the form view (simple approach) or just show a message
            showModal('æ–°å¢æ’ç¨‹', `è«‹åœ¨å³å´è¡¨å–®å¡«å¯« ${date} çš„äº‹é …ã€‚`);
        }
        window.showCalendarModal = showCalendarModal;

        const handleCalendarEvent = async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('event_project_id').value;
            const date = document.getElementById('event_date').value;
            const task = document.getElementById('event_task').value;
            // UPDATED: Get manager from new dropdown
            const manager = document.getElementById('event_manager').value || 'æœªæŒ‡å®š'; 
            
            if (!projectId || !date || !task) {
                await showModal('éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚');
                return;
            }

            const docRef = doc(db, getPrivateCollectionPath('projects'), projectId);
            const newEvent = { date, task, manager, eventId: Date.now() };

            try {
                await runTransaction(db, async (transaction) => {
                    const projectDoc = await transaction.get(docRef);
                    if (!projectDoc.exists()) throw "Project does not exist!";
                    
                    const currentEvents = projectDoc.data().calendar_events || [];
                    const updatedEvents = [...currentEvents, newEvent];
                    
                    transaction.update(docRef, { calendar_events: updatedEvents });
                });
                
                document.getElementById('calendar-event-form').reset();
                await showModal('æˆåŠŸ', `æ’ç¨‹äº‹é …ã€Œ${task}ã€å·²æˆåŠŸæ–°å¢åˆ° ${date}ã€‚`);
            } catch (error) {
                console.error("Error adding calendar event:", error);
                await showModal('éŒ¯èª¤', 'æ–°å¢æ’ç¨‹äº‹é …å¤±æ•—ã€‚');
            }
        };

        // 5. New View: Manager Management (managers-view)
        const renderManagersView = () => {
            const html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Add Manager Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">æ–°å¢å°ˆæ¡ˆç®¡ç†äºº</h2>
                        <form id="add-manager-form" class="space-y-4">
                            <input type="text" id="new_manager_name" placeholder="è¼¸å…¥ç®¡ç†äººå§“å" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors shadow-md">
                                æ–°å¢ç®¡ç†äºº
                            </button>
                        </form>
                    </div>

                    <!-- Manager List -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">ç¾æœ‰å°ˆæ¡ˆç®¡ç†äºº (${availableManagers.length} ä½)</h2>
                        <ul class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                            ${availableManagers.length === 0 ? '<li class="text-gray-500 py-4 text-center">ç›®å‰æ²’æœ‰ç®¡ç†äºº</li>' :
                                availableManagers.map(m => `
                                    <li class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                                        <span class="font-medium text-gray-800">${m.name}</span>
                                        <button onclick="window.handleDeleteManager('${m.id}', '${m.name}')" class="text-red-600 hover:text-red-800 text-sm font-medium p-1 rounded-md transition-colors hover:bg-red-100">
                                            åˆªé™¤
                                        </button>
                                    </li>
                                `).join('')
                            }
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('managers-view').innerHTML = html;
            document.getElementById('add-manager-form').onsubmit = handleAddManager;
        };

        const handleAddManager = async (e) => {
            e.preventDefault();
            const name = document.getElementById('new_manager_name').value.trim();
            if (!name) return;

            if (availableManagers.some(m => m.name === name)) {
                await showModal('éŒ¯èª¤', `ç®¡ç†äºº ${name} å·²å­˜åœ¨ã€‚`);
                return;
            }

            const managerCollectionRef = collection(db, getPrivateCollectionPath('managers'));
            try {
                // Use name as doc ID for simplicity in management view
                await setDoc(doc(managerCollectionRef, name), { name: name, createdAt: serverTimestamp() });
                document.getElementById('add-manager-form').reset();
                await showModal('æˆåŠŸ', `ç®¡ç†äºº ${name} å·²æˆåŠŸæ–°å¢ï¼`);
            } catch (error) {
                console.error("Error adding manager:", error);
                await showModal('éŒ¯èª¤', 'æ–°å¢ç®¡ç†äººå¤±æ•—ã€‚');
            }
        };

        const handleDeleteManager = async (managerId, managerName) => {
            const confirmed = await showModal('ç¢ºèªåˆªé™¤', `æ‚¨ç¢ºå®šè¦åˆªé™¤ç®¡ç†äººã€Œ${managerName}ã€å—ï¼Ÿå»ºè­°æª¢æŸ¥æ‰€æœ‰å°ˆæ¡ˆä¸¦é‡æ–°æŒ‡æ´¾ç›¸é—œå°ˆæ¡ˆç®¡ç†äººã€‚`, true);
            if (!confirmed) return;

            try {
                await deleteDoc(doc(db, getPrivateCollectionPath('managers'), managerId));
                await showModal('æˆåŠŸ', `ç®¡ç†äººã€Œ${managerName}ã€å·²æˆåŠŸåˆªé™¤ã€‚`);
            } catch (error) {
                console.error("Error deleting manager:", error);
                await showModal('éŒ¯èª¤', 'åˆªé™¤ç®¡ç†äººå¤±æ•—ã€‚');
            }
        };
        window.handleDeleteManager = handleDeleteManager; // Expose to global scope for HTML event

        // 6. AI Analysis View (Mock Implementation)
        const renderAIAnalysis = () => {
            const html = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">AI å°ˆæ¡ˆæ´»å‹•åˆ†æå ±å‘Š</h2>
                    <p class="text-gray-600 mb-4">æ­¤åŠŸèƒ½å°‡ä½¿ç”¨ AI æ ¹æ“šæ‚¨çš„å°ˆæ¡ˆæ•¸æ“šèˆ‡æ´»å‹• (ä¾‹å¦‚è¡Œäº‹æ›†äº‹ä»¶ã€è²»ç”¨å¡«å ±) ç”Ÿæˆä¸€ä»½æ¯é€±/æ¯æœˆåˆ†æå ±å‘Šæˆ–è¨ˆç•«å»ºè­°ã€‚è¨ˆç•«åŸ·è¡Œæ™‚é–“ç‚ºï¼š<span class="font-bold text-red-500">114/09/01 - 115/12/31</span>ã€‚</p>
                    
                    <div class="flex space-x-4 mb-4">
                        <select id="report_period" class="p-2 border rounded-lg">
                            <option value="weekly">æ¯é€±å ±å‘Š</option>
                            <option value="monthly">æ¯æœˆå ±å‘Š</option>
                        </select>
                        <button id="generate-ai-report" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md">
                            ç”Ÿæˆå ±å‘Š
                        </button>
                    </div>

                    
                    <div id="ai-report-output" class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 min-h-[200px]">
                        <p class="text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹ç”Ÿæˆå ±å‘Š...</p>
                    </div>
                    
                    <div id="ai-loading-indicator" class="mt-4 hidden flex items-center text-indigo-600">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        å ±å‘Šç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...
                    </div>
                </div>
            `;
            document.getElementById('ai-analysis-view').innerHTML = html;
            document.getElementById('generate-ai-report').onclick = generateAIReport;
        };

        const generateAIReport = async () => {
            const outputDiv = document.getElementById('ai-report-output');
            const loadingIndicator = document.getElementById('ai-loading-indicator');
            const generateButton = document.getElementById('generate-ai-report');
            const period = document.getElementById('report_period').value === 'weekly' ? 'æ¯é€±' : 'æ¯æœˆ';

            outputDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            generateButton.disabled = true;

            // Construct a comprehensive prompt based on current data
            const projectSummaries = allProjects.map(p => {
                const totalBudget = (p.budget_personnel || 0) + (p.budget_operating || 0) + (p.budget_equipment || 0);
                const totalSpent = (p.expenses || []).reduce((sum, exp) => sum + exp.amount, 0); // NEW: Use detailed expense sum
                const events = (p.calendar_events || []).map(e => `[${e.date}] ${e.task} (${e.manager})`).join('; ');
                
                const managers = (p.managers && Array.isArray(p.managers)) ? p.managers.join(', ') : (p.manager || 'ç„¡');
                const status = p.status === 'completed' ? 'å·²çµæ¡ˆ' : 'åŸ·è¡Œä¸­';
                const expenseCount = (p.expenses || []).length;

                return `
                    - è¨ˆç•«é¡Œç›®: ${p.title}
                    - ç‹€æ…‹: ${status}
                    - ç®¡ç†äºº: ${managers}
                    - ç¸½é ç®—: ${totalBudget}
                    - å·²èŠ±è²»: ${totalSpent} (é¤˜é¡: ${totalBudget - totalSpent})
                    - è²»ç”¨ç­†æ•¸: ${expenseCount}
                    - ${period}ä¸»è¦æ´»å‹•/æ’ç¨‹: ${events || 'ç„¡'}
                `;
            }).join('\n');
            
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ˆæ¡ˆç¶“ç†åŠ©ç† AIã€‚è«‹æ ¹æ“šæä¾›çš„å°ˆæ¡ˆæ•¸æ“šï¼Œç”Ÿæˆä¸€ä»½è©³ç›¡çš„ã€Œ${period}å°ˆæ¡ˆæ´»å‹•åˆ†æèˆ‡å»ºè­°å ±å‘Šã€ã€‚å ±å‘Šæ‡‰åŒ…å«ï¼š
                1. æ¥­å‹™é€²åº¦åˆ†æï¼šæ ¹æ“šå°ˆæ¡ˆç‹€æ…‹å’Œæ´»å‹•ï¼Œåˆ¤æ–·æ•´é«”åŸ·è¡Œé€²åº¦ã€‚
                2. è²»ç”¨èŠ±è²»åˆ†æï¼šç¸½çµæ‰€æœ‰å°ˆæ¡ˆçš„è²¡å‹™ç‹€æ³ï¼ŒæŒ‡å‡ºé ç®—ä½¿ç”¨ç‡é«˜ä½æˆ–è¶…æ”¯å°ˆæ¡ˆã€‚
                3. å»ºè­°èˆ‡æé†’ï¼šæ ¹æ“šè¨ˆç•«çš„æ™‚é–“ç¯„åœ (114/09/01 - 115/12/31) å’Œç•¶å‰åŸ·è¡Œç‹€æ³ï¼Œæä¾›å°ˆæ¥­çš„è²»ç”¨æ§åˆ¶ã€é€²åº¦æ¨é€²å»ºè­°ã€‚
                è«‹ä»¥ AI åŠ©ç†çš„è§’åº¦ï¼Œä½¿ç”¨è¦ªåˆ‡ä¸”å°ˆæ¥­çš„èªæ°£ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œå ±å‘Šæ ¼å¼è«‹ä½¿ç”¨ Markdownã€‚`;
            
            const userQuery = `è«‹åˆ†æä»¥ä¸‹å°ˆæ¡ˆæ•¸æ“šä¸¦ç”Ÿæˆå ±å‘Š:\n\nç¸½å°ˆæ¡ˆæ•¸: ${totalMetrics.totalProjects}\nç¸½é ç®—: ${totalMetrics.totalBudget}\n\nè©³ç´°å°ˆæ¡ˆæ•¸æ“š:\n${projectSummaries}`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                // Exponential Backoff implementation (omitted for brevity, but required in production)
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "AI å ±å‘Šç”Ÿæˆå¤±æ•—ã€‚";
                
                outputDiv.innerHTML = `<div class="prose max-w-none">${text.replace(/\n/g, '<br>')}</div>`;
                
            } catch (error) {
                console.error("AI API call failed:", error);
                outputDiv.innerHTML = '<p class="text-red-600">é€£ç·šéŒ¯èª¤æˆ– API å‘¼å«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            } finally {
                loadingIndicator.classList.add('hidden');
                generateButton.disabled = false;
            }
        };


        // 7. Information Exchange View (Public Messaging/Blog)
        const renderExchange = () => {
            const html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Message Feed -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800">è³‡è¨Šäº¤æµç•™è¨€å€</h2>
                        <div id="message-feed" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                            ${exchangeMessages.length === 0 ? '<p class="text-gray-500 text-center py-12">ç›®å‰æ²’æœ‰ç•™è¨€ã€‚</p>' : 
                                exchangeMessages.map(m => {
                                    const isCurrentUser = m.userId === userId;
                                    const timestamp = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleString('zh-TW') : 'å‰›å‰›';
                                    const bgColor = isCurrentUser ? 'bg-indigo-50' : 'bg-gray-50';
                                    const borderColor = isCurrentUser ? 'border-indigo-400' : 'border-gray-300';
                                    
                                    return `
                                        <div class="p-3 rounded-lg border-l-4 ${bgColor} ${borderColor} shadow-sm">
                                            <div class="flex justify-between items-center mb-1">
                                                <p class="text-xs font-semibold text-gray-700">ç”¨æˆ¶ID: ${m.userId} ${isCurrentUser ? '(æ‚¨)' : ''}</p>
                                                <p class="text-xs text-gray-500">${timestamp}</p>
                                            </div>
                                            <p class="text-gray-800">${m.content}</p>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                    
                    <!-- Post Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">ç™¼è¡¨ç•™è¨€</h2>
                        <form id="exchange-post-form" class="space-y-4">
                            <textarea id="post_content" rows="4" placeholder="è¼¸å…¥æ‚¨çš„æ–‡å­—/ç•™è¨€..." required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md">
                                ç™¼è¡¨
                            </button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('exchange-view').innerHTML = html;
            document.getElementById('exchange-post-form').onsubmit = handleNewMessage;
            
            // Scroll to the top of the message feed after rendering
            const messageFeed = document.getElementById('message-feed');
            if (messageFeed) messageFeed.scrollTop = 0;
        };
        
        const handleNewMessage = async (e) => {
            e.preventDefault();
            const content = document.getElementById('post_content').value.trim();
            if (!content) return;

            const postData = {
                userId: userId,
                content: content,
                timestamp: serverTimestamp(),
            };
            
            try {
                await addDoc(collection(db, getPublicCollectionPath('messages')), postData);
                document.getElementById('post_content').value = ''; // Clear textarea
                // Message feed will update automatically via onSnapshot
            } catch (error) {
                console.error("Error posting message:", error);
                await showModal('éŒ¯èª¤', 'ç™¼è¡¨ç•™è¨€å¤±æ•—ã€‚');
            }
        };

        // --- Event Listeners for Navigation ---
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const view = e.currentTarget.getAttribute('data-view');
                switchView(view);
            });
        });

        // Expose switchView globally for use in dynamic HTML content (e.g., project list clicks)
        window.switchView = switchView; 
        
    </script>

</body>
</html>
